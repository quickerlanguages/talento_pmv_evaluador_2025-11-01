name: Release on tag (rel/*)

on:
  push:
    tags:
      - 'rel/*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full + exact tag + tags)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}     # checkout EXACTO del tag que dispara
          fetch-depth: 0             # historia completa
          fetch-tags: true

      - name: Quick debug (Makefile + dist target)
        run: |
          pwd
          ls -la
          if [ ! -f Makefile ] && [ ! -f makefile ]; then
            echo "✖ No hay Makefile en $(pwd)"
            exit 1
          fi
          echo "— Cabecera del Makefile —"
          sed -n '1,200p' Makefile 2>/dev/null || sed -n '1,200p' makefile || true
          echo "— Buscando diana 'dist' —"
          if ! grep -nE '^[[:space:]]*(\.PHONY:.*\bdist\b|dist:)' Makefile makefile 2>/dev/null; then
            echo "✖ La diana 'dist' no existe en este commit/tag"
            exit 1
          fi

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip sqlite3 curl jq lsof

      - name: Build dist (ZIP reproducible + SHA)
        run: |
          make dist
          make dist-check
          make dist-verify

      - name: Publish GitHub Release (via Makefile)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          make release-gh CUSTOM_TAG="${GITHUB_REF_NAME}"