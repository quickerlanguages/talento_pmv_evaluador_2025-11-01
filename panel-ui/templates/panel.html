<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Talento · Panel Orientador (PMV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-3">Panel Orientador — PMV</h1>

    <!-- Importar sesiones -->
    <div class="mb-3 d-flex gap-2">
      <input id="adm_token" class="form-control" style="max-width:240px" placeholder="Admin token (pmv-local)">
      <button id="btnIngest" class="btn btn-secondary">Importar sesiones</button>
    </div>
    <script>
    document.getElementById('btnIngest').onclick = async () => {
      const t = document.getElementById('adm_token').value || 'pmv-local';
      const r = await fetch('/admin/ingest?token='+encodeURIComponent(t), {method:'POST'});
      const j = await r.json();
      alert(j.ok ? ('OK\n'+(j.stdout||'')) : ('ERROR\n'+(j.stderr||j.error||'')));
      if (j.ok) location.reload();
    };
    </script>

    {% if kpis.error %}
      <div class="alert alert-danger">Error DB: {{kpis.error}}</div>
    {% else %}
      <div class="row">
        <div class="col-md-6">
          <h5 class="mb-2">Acierto % por CCP</h5>
          <canvas id="chart1"></canvas>
        </div>
        <div class="col-md-6">
          <h5 class="mb-2">TR medio (ms) por CCP</h5>
          <canvas id="chart2"></canvas>
        </div>
      </div>
      <div class="table-responsive mt-4">
        <table class="table table-sm table-striped">
          <thead class="table-light">
            <tr><th>CCP</th><th>N</th><th>Acierto %</th><th>TR ms</th></tr>
          </thead>
          <tbody>
            {% for r in kpis.rows %}
            <tr>
              <td>{{r.ccp}}</td>
              <td>{{r.n}}</td>
              <td>{{r.acierto_pct}}</td>
              <td>{{r.tr_ms}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

    <!-- Datos para JS en JSON puro -->
  <script id="kpis-data" type="application/json">{{ kpis.rows|tojson }}</script>

  <script>
  // Recuperar datos sin incrustar expresiones Jinja en el JS
  const rows = JSON.parse(document.getElementById('kpis-data').textContent);
  const labels = rows.map(r=>r.ccp);
  const acc    = rows.map(r=>r.acierto_pct);
  const tr     = rows.map(r=>r.tr_ms);

  new Chart(document.getElementById('chart1'), {
    type:'bar',
    data:{labels, datasets:[{label:'Acierto %', data:acc}]},
    options:{responsive:true, maintainAspectRatio:false}
  });
  new Chart(document.getElementById('chart2'), {
    type:'bar',
    data:{labels, datasets:[{label:'TR ms', data:tr}]},
    options:{responsive:true, maintainAspectRatio:false}
  });
  </script>
</body>
</html>